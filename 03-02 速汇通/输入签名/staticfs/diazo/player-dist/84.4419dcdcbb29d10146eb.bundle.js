(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{2672:function(e,t,n){var a,i;a=[n(100),n(8),n(10),n(14),n(78),n(27),n(814),n(4)],void 0===(i=function(e,t,a,i,o,r,s,d){"use strict";var u=n(0);i=u(i),o=u(o),r=u(r),s=u(s),d=u(d),epub360.PlayerPlugins.push({config:{type:"LayerLongTake",template:"LayerRef",Model:"LayerRef",model_object:{setiview:function(){this.iview=new interaction_view.view.LayerLongTake({model:this})}}},render:function(e){},playAnimation:function(){},getLayerContentSize:function(){var e=this.getdetail(),t={};if(!e.layer_ids||e.layer_ids.length>0){var n=(0,i.default)(_).call(_,e.layer_ids,(function(e){return interaction_view.ilayerlist.get(e).toJSON()}));return t.width=_.max(_.pluck(n,"layer_width")),t.height=_.max(_.pluck(n,"layer_height")),t}return null},immediateRender:function(){var e=e||this,t=this.$el.children(".Element"),n={width:t.width(),height:t.height()},a=(0,o.default)(t).call(t,".layer-content");if(a.length){a.preCachedSize=n,e.playNestedAnimation(),e.preparePano(a);e.__pano;e.showRangedOnly(0),e.initControlEvents()}},onPlay:function(){var e=e||this,t=e.__pano;t&&t.autoPlay&&(e.updateStatus("play"),t.normalSpeed=t.playSpeed,e.startMoving())},onStop:function(){var e=e||this;e.__pano;e.resetlayer(),e.stoplayer(),e.__pano&&e.stopMoving(),e.showRangedOnly(0),this.destoryDragEvent()},panolog:function(){},playNestedAnimation:function(){var e=e||this;e.__pano;_.each(e.getdetail().layer_ids,(function(t){e.model.layer[t].isLayer=!0,interaction_view.play(e.model.layer[t])}))},preparePano:function(e){var t=t||this;t.prefixTouch(),t.initPanoSetting();var n,a=t.__pano;a.items&&a.items.length?n=a.items:(n=t.calcItemsData(e),a.items=n),t.mappingDepth(n,e),t.initStage(e),t.modeling(n,e),t.showRangedOnly(a.currentDepth)},prefixTouch:function(){var e=this.$el.children(".Element");(0,o.default)(e).call(e,".layer-item").children().css({"pointer-events":"initial"}),(0,o.default)(e).call(e,".layer-item").css({"pointer-events":"none"}),(0,o.default)(e).call(e,".layer-bg").css({"pointer-events":"none"}),e.addClass("disableDragX disableDragY")},initPanoSetting:function(){var e=e||this,t=e.getdetail();e.__pano=e.__pano||{zDirection:-1,iStage:void 0,iSprite:void 0,layerIdMap:[],$elMap:[],length:0,fov:0,iInitialTrim:t.iInitialTrim||void 0===t.iInitialTrim,depthMax:0,currentDepth:0,renderRange:3e3,renderCount:20,dragSpeedRatio:100,rafDecrease:0,autoPlay:t.iTakeAutoPlay,playSpeed:t.iAutoPlaySpeed/60,viewRangeMap:[],itemDepthMap:[],viewDepthMap:[],viewIndex:0,lastViewIndex:0,goneIndex:-1,movedCheckRange:100,destIndex:0,destDepth:0,triggered:{itemEvent:!1,endEvent:!1},touchRecord:[0,0,0],currentSpeed:0,normalSpeed:0,sensorSpeed:0,status:"stop",lastStatus:"stop",played:!1},e.__pano.draggable=void 0===t.iTakeDraggable||Boolean(t.iTakeDraggable),e.__pano.useSensor=void 0!==t.iTakeUseSensor&&Boolean(t.iTakeUseSensor)},calcItemsData:function(e){var t=t||this,n=t.__pano,a=t.getdetail(),r=a.distanceMap,s=[],d=(0,i.default)(Array.prototype).call(e.children(".layer-item"),(function(e){var t=$(e).css({opcaity:""});return"0"==(0,o.default)(t).call(t,".layer-bg").css("opacity")&&(0,o.default)(t).call(t,".layer-bg").remove(),s.push(t.data("id")),{$el:t,distance:r[$(e).data("id")]}}));n.layerIdMap=s;var u=t.calcFOV(d[0].$el,e);return n.fov=u,a.iInitialTrim&&(d[0].distance=u),d},mappingDepth:function(e,t){var n,a=a||this,o=a.__pano;a.getdetail();n=0,o.itemDepthMap=(0,i.default)(e).call(e,(function(e){return n+=e.distance})),n=0-o.fov;var r=(0,i.default)(e).call(e,(function(e){return n+=e.distance}));o.viewDepthMap=r,o.depthMax=n;for(var s=[],d=1;d<r.length;d++)s.push((r[d]+r[d-1])/2);s.push(n+1),o.viewRangeMap=s},initStage:function(e){var t=t||this,n=t.__pano,a=e.preCachedSize,i=(new window.C3D.Stage).size(a.width,a.height).update();$(i.el).css({"z-index":1}),e.append(i.el),n.iStage=i},modeling:function(e,t){for(var n=n||this,a=n.__pano,i=a.itemDepthMap,r=new window.C3D.Sprite,s=0;s<e.length;s++){var d=e[s].$el;d.css("z-index",e.length-s);var u=new window.C3D.Plane({el:d[0]}).size(d.width(),d.height()).position(0,0,-i[s]).update();r.addChild(u)}r.position(0,0,0),r.updateT(),a.iStage.addChild(r),a.iSprite=r,a.$elMap=(0,o.default)(t).call(t,".layer-item"),a.length=a.$elMap.length},calcFOV:function(e,t){var n=.65*e.height(),a=t.height()/t.width()/(e.height()/e.width());return a>1&&(n*=a),n},startMoving:function(){var e=e||this,t=e.__pano;t.currentDepth=t.iSprite.z,cancelAnimationFrame(e.panoRafId),e.panoRafId=requestAnimationFrame(e.panoRafFn)},alignStop:function(){var e=e||this,t=e.__pano;t.currentDepth=t.viewDepthMap[t.viewIndex],t.iSprite.z=t.currentDepth,e.stopMoving()},stopMoving:function(){var e,t=t||this,n=t.__pano;t.updateStatus("stop"),n.speedBeforeStop=n.normalSpeed,n.normalSpeed=0,n.currentSpeed=n.normalSpeed+n.sensorSpeed,(0,r.default)(e=n.touchRecord).call(e,0),t.updatePanoRender(),cancelAnimationFrame(t.panoRafId),"slide"==n.lastStatus&&t.sensor&&"on"==t.sensor.status&&(t.updateStatus("slip"),t.sensor.markStart(),t.startMoving())},panoRafFn:function(){var e=e||this;e.__pano;e.panoRafId=requestAnimationFrame(e.panoRafFn),e.updatePanoData()},updatePanoData:function(){var e=e||this,t=e.__pano;"drag"==t.status||"slide"==t.status?t.currentSpeed=t.normalSpeed:t.currentSpeed=t.normalSpeed+t.sensorSpeed;var n=t.currentSpeed,a=t.currentDepth;t.iSprite.move(0,0,n);var i=t.iSprite.z,o=e.preventRange(i,[0,t.depthMax]);t.iSprite.z=o,t.currentDepth=o,e.despatchCurrentEvent(a,o),e.despatchSelfEvent(a,o),"drag"!=t.status&&("slide"==t.status?e.softEqual(t.destDepth,a,1.2*n)&&(t.iSprite.z=t.destDepth,e.stopMoving(),e.triggerIntoItem(),e.softEqual(t.currentDepth,t.depthMax)&&e.triggerEndPlay()):i==o&&a!=o||e.stopMoving()),t.rafDecrease=t.rafDecrease?0:1,t.rafDecrease&&e.updatePanoRender()},updatePanoRender:function(){var e=e||this,t=e.__pano;t.iSprite.updateT(),e.showRangedOnly(t.currentDepth)},showRangedOnly:function(e){for(var t,n=n||this,a=n.__pano,i=a.length,o=a.renderRange+e,r=t=null,s=0;s<i;s++)if(a.itemDepthMap[s]>e-10){r=s;break}for(s=0;s<i;s++)if(a.itemDepthMap[s]>o){t=s;break}t=t>0?t:i,t=Math.min(t,r+a.renderCount);for(s=0;s<i;s++)a.$elMap[s].style.display=r<=s&&s<t?"block":"none"},preventRange:function(e,t){return Math.min(Math.max(e,t[0]),t[1])},softEqual:function(e,t,n){return n=null!=n?Math.abs(n):1e-6,e==t||Math.abs(e-t)<n},isAligned:function(e){var t=t||this,n=t.__pano;return t.softEqual(n.currentDepth,n.viewDepthMap[n.viewIndex],e)},updateStatus:function(e){var t=t||this,n=t.__pano;n.lastStatus=n.status,n.status=e},despatchCurrentEvent:function(e,t){var n,a,i,o,r=r||this,d=r.__pano,u=d.currentSpeed,l=(d.viewIndex,d.goneIndex);i=(0,s.default)(n=d.viewRangeMap).call(n,(function(e){return t<e})),o=(0,s.default)(a=d.itemDepthMap).call(a,(function(e){return t<e+.5}))-1,d.viewIndex=i,d.goneIndex=o,d.lastViewIndex==i&&r.isAligned(d.movedCheckRange)||(d.triggered.itemEvent=!1,d.triggered.endEvent=!1,d.lastViewIndex=i),"slide"!=d.status&&(r.isAligned(.8*u)&&r.triggerIntoItem(),u>0&&l!=o&&r.triggerGoneItem())},despatchSelfEvent:function(e,t){var n=n||this,a=n.__pano;0==a.played&&a.currentSpeed>0&&(a.played=!0,n.triggerStartPlay()),t==a.depthMax&&a.currentSpeed>0&&n.triggerEndPlay()},triggerStartPlay:function(){var e=e||this;e.__pano;interaction_view.events.onLongTakeStart(e,{})},triggerEndPlay:function(){var e=e||this,t=e.__pano;t.triggered.endEvent||(t.triggered.endEvent=!0,interaction_view.events.onLongTakeEnd(e,{}))},triggerIntoItem:function(){var e=e||this,t=e.__pano;if(!t.triggered.itemEvent){t.triggered.itemEvent=!0;var n=t.layerIdMap[t.viewIndex];if(null!=n){var a={ref_id:e.model.id,layer_id:n,page_id:e.model.iPageId};interaction_view.events.onLTLayerInto(a)}}},triggerGoneItem:function(){this.triggerGoneItem=_.debounce((function(){var e=e||this,t=e.__pano,n=t.layerIdMap[t.viewIndex];if(null!=n){var a={ref_id:e.model.id,layer_id:n,page_id:e.model.iPageId};interaction_view.events.onLTLayerGone(a)}}),20,!0),this.triggerGoneItem()},initControlEvents:function(){var e=e||this,t=e.__pano;t.touching=!1,t.draggable&&e.initDragEvent(),e.initSlideEvent(),t.useSensor&&e.initSensorEvent()},get touchOpts(){return window._g.util.passiveFalse},initDragEvent:function(){var e=e||this;e.__pano,this.$el.children(".Element").on("mousedown",e.onDocumentMouseDown).on("touchstart",e.onDocumentTouchStart)},destoryDragEvent:function(){var e=e||this;this.$el.children(".Element").off("mousedown",e.onDocumentMouseDown).off("touchstart",e.onDocumentTouchStart)},onDocumentMouseDown:function(e){document.addEventListener("mousemove",this.onDocumentMouseMove,this.touchOpts),document.addEventListener("mouseup",this.onDocumentMouseUp,this.touchOpts),this.dragStart(e.clientX,e.clientY)},onDocumentMouseMove:function(e){this.dragMove(e.clientX,e.clientY)},onDocumentMouseUp:function(e){document.removeEventListener("mousemove",this.onDocumentMouseMove),document.removeEventListener("mouseup",this.onDocumentMouseUp),this.dragEnd(e.clientX,e.clientY)},onDocumentTouchStart:function(e){document.addEventListener("touchmove",this.onDocumentTouchMove,this.touchOpts),document.addEventListener("touchend",this.onDocumentTouchEnd,this.touchOpts),this.dragStart(e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY)},onDocumentTouchMove:function(e){e.preventDefault(),this.dragMove(e.touches[0].clientX,e.touches[0].clientY)},onDocumentTouchEnd:function(e){0==e.touches.length&&(document.removeEventListener("touchmove",this.onDocumentTouchMove),document.removeEventListener("touchend",this.onDocumentTouchEnd),this.dragEnd(e.changedTouches[0].clientX,e.changedTouches[0].clientY))},dragStart:function(e,t){var n=window.emulateLandscape.emulateDelta(e,t);e=n[0],t=n[1];var a,i=i||this,o=i.__pano;o.touching||(o.touching=!0,o.touchPoint=[e,t],(0,r.default)(a=o.touchRecord).call(a,o.touchPoint),i.updateStatus("drag"),i.pointRafId=requestAnimationFrame(i.pointRafFn),i.startMoving())},dragMove:function(e,t){var n=window.emulateLandscape.emulateDelta(e,t);e=n[0],t=n[1],this.__pano.touchPoint=[e,t]},dragEnd:function(e,t){var n=window.emulateLandscape.emulateDelta(e,t);e=n[0],t=n[1];var a=a||this,i=a.__pano;i.touching=!1,i.touchPoint=[e,t],a.updateStatus("slip"),a.sensor&&"on"==a.sensor.status&&a.sensor.markStart(),cancelAnimationFrame(a.pointRafId)},pointRafFn:function(){var e=e||this,t=e.__pano;t.touchRecord.push(t.touchPoint||0),t.touchRecord.shift();var n=[(t.touchRecord[2][0]-t.touchRecord[0][0])/2,(t.touchRecord[2][1]-t.touchRecord[0][1])/2];t.normalSpeed=e.translateSpeed(n[1]*t.zDirection,t.dragSpeedRatio)||0,e.pointRafId=requestAnimationFrame(e.pointRafFn)},translateSpeed:function(e,t){var n=1;return e<0&&(n=-1,e=-e),Math.log(e/t+1)*t*n*.3},initSlideEvent:function(){},setElementTo:function(e){var t=t||this,n=t.__pano;switch(e){case"first":e=0;break;case"last":e=n.length-1;break;case"prev":e=n.viewIndex-1;break;case"next":e=n.viewIndex+1}if(e=t.preventRange(e,[0,n.length-1]),n.destIndex=e,n.destDepth=n.viewDepthMap[e],t.softEqual(n.currentDepth,n.viewDepthMap[e],n.currentSpeed))t.alignStop();else{t.updateStatus("slide");n.normalSpeed=(n.destDepth-n.currentDepth)/500*1e3/60,t.startMoving()}},initSensorEvent:function(){var e=e||this;e.__pano;this.sensorStart(),e.sensorRafId=requestAnimationFrame(e.sensorRafFn)},sensorRafFn:function(){var e=e||this;e.__pano.sensorSpeed=this.sensor.deltaPoint[1]/-1,"stop"==this.__pano.status&&this.startMoving(),e.sensorRafId=requestAnimationFrame(e.sensorRafFn)},sensorStart:function(){var e=function(){var e;this.id=(0,d.default)(e=Math.random().toString(36)).call(e,-6),this.initData()};_.extend(e.prototype,{initData:function(){return this.point=[0,0,0],this.deltaPoint=[0,0,0],this.startPoint=[0,0,0],this.status="off",this.__raw={alpha:0,beta:0,gamma:0,alpha0:void 0,beta0:void 0,gamma0:void 0},this},recordPoint:function(e){var t=this.__raw;return e&&e.originalEvent&&(e=e.originalEvent,t.alpha=e.alpha,t.beta=e.beta,t.gamma=e.gamma,this.point[0]=t.alpha,this.point[1]=t.beta,this.point[2]=t.gamma),this.setDelta(),this},setDelta:function(){var e=this.__raw;void 0!==e.alpha0&&(this.deltaPoint[0]=e.alpha-e.alpha0,this.deltaPoint[1]=e.beta-e.beta0,this.deltaPoint[2]=e.gamma-e.gamma0)},markStart:function(e){var t=this.__raw;return e&&e.originalEvent?(e=e.originalEvent,t.alpha0=e.alpha,t.beta0=e.beta,t.gamma0=e.gamma):(t.alpha0=t.alpha,t.beta0=t.beta,t.gamma0=t.gamma),this.startPoint[0]=t.alpha0,this.startPoint[1]=t.beta0,this.startPoint[2]=t.gamma0,this.setDelta(),this},turn:function(e){return"on"==e&&this.turnOn(),"off"==e&&this.turnOff(),this},turnOn:function(){var e=this.__raw;if("on"!=this.status){this.status="on",e.recordPoint=this.recordPoint.bind(this),e.markStart=this.markStart.bind(this),$(window).on("deviceorientation",e.recordPoint),$(window).on("deviceorientation",(function t(n){setTimeout((function(){e.markStart(n),void 0!==e.alpha0&&$(window).off("deviceorientation",t)}),0)}))}return this},turnOff:function(){return $(window).off("deviceorientation",this.__raw.recordPoint),this.status="off",this.initData(),this}}),this.sensor=new e,this.sensor.turn("on")}})}.apply(t,a))||(e.exports=i)}}]);