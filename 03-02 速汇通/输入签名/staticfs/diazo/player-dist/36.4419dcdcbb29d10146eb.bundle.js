(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{2652:function(t,e,i){var n,a;n=[i(8),i(10),i(100),i(215),i(4),i(78),i(14),i(63),i(154),i(814),i(99),i(2653)],void 0===(a=function(t,e,n,a,s,r,o,h,u,l,d,c){"use strict";var f=i(0);a=f(a),s=f(s),r=f(r),o=f(o),h=f(h),u=f(u),l=f(l),d=f(d),c=f(c),window.setRaf=function(t){var e=null,i={valueOf:function(){return e}};if("function"==typeof t){!function i(){t(),e=requestAnimationFrame(i)}()}return i},window.clearRaf=function(t){cancelAnimationFrame(t)};var p="LayerRound",g="走马灯";"function"!=typeof a.default&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),n=1;n<arguments.length;n++){var a=arguments[n];if(null!=a)for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(i[s]=a[s])}return i},writable:!0,configurable:!0});var m=function(){this.start()},v=m,w=function(){this.initialize()},y=function(){var t;this.id=(0,s.default)(t=Math.random().toString(36)).call(t,-6),this.initData()},S=-1,P=function(){var t,e=arguments[0];(0,r.default)(t=e.$el.children(".Element")).call(t,".layer-content").children(".layer-item").length&&(this.initBasicData.apply(this,arguments),this.calcItemsData(),this.mappingStamps(),this.initStage(),this.modeling(),this.showRangedOnly(),this.timeSensor=new v,this.touchSensor=new w,this.orientSensor=new y,this.panoRafFn=this.panoRafFn.bind(this),this.setting.draggable&&(this.PanoTouchEvent=this.createPanoTouchEvent()),this.autoPlay())};(0,a.default)(P.prototype,{autoPlay:function(){(this.setting.autoPlay||this.setting.orientable)&&(this.setting.autoPlay&&(this.status.currentProgress=0,this.status.rawSpeed=this.setting.playSpeed),this.setting.orientable&&this.orientSensor.turnOn(),this.updateStatus("slip"),this.timeSensor.delta,this.flag.panoRafId=requestAnimationFrame(this.panoRafFn),this.status.flagProgress=this.status.currentProgress)},initBasicData:function(t){var e;this.type=p,this.name=g,this.uid=p+"-"+I();var i=t.getdetail();this.setting={draggable:i.iRoundDraggable,orientable:i.iRoundUseSensor,autoPlay:i.iRoundAutoPlay,playSpeed:i.iAutoPlaySpeed,useInitialSpacing:i.iUseInitialDegree,initialSpacing:i.iInitialDegree,chirality:i.iRoundChirality,axiaProfile:i.iRoundAxiaProfile},S={normal:1,invert:-1}[this.setting.chirality],this.config={directionY:-1,renderRange:3e3,renderCount:20,dragSpeedRatio:100,movedCheckRange:100,kProgress:.04},this.$el=t.$el,this.$dest=(0,r.default)(e=this.$el.children(".Element")).call(e,".layer-content"),this.viewObject=t,this.info={layerIdList:i.layer_ids,deltaSpacingMap:i.degreeMap,progressStampList:[]},this.C3dObject={},this.status={currentProgress:0,currentScopeIndex:0,lastViewStampIndex:0,goneStampIndex:-1,destStampIndex:0,destProgress:0,triggered:{itemEvent:!1,endEvent:!1},status:"stop",lastStatus:"stop",played:!1},this.flag={panoRafId:null}},prefixTouch:function(){var t=this.$el.children(".Element");(0,r.default)(t).call(t,".layer-item").children().css({"pointer-events":"initial"}),(0,r.default)(t).call(t,".layer-item").css({"pointer-events":"none"}),(0,r.default)(t).call(t,".layer-bg").css({"pointer-events":"none"}),t.addClass("disableDragX disableDragY")},calcItemsData:function(){var t=this.$dest,e=this.info.deltaSpacingMap,i=(0,o.default)(Array.prototype).call(t.children(".layer-item"),(function(t){var i=$(t).data("id"),n=$(t);n.css({opcaity:"0.3"});var a=interaction_view.ilayerlist.get(i).toJSON();return{$el:n,deltaSpacing:e[i],width:a.layer_width,height:a.layer_height,layerId:i}}));this.setting.useInitialSpacing&&(i[0].deltaSpacing=this.setting.initialSpacing),this.info.panoModelInfoList=i,this.info.layerIdList=(0,o.default)(i).call(i,(function(t){return t.layerId})),this.calcItemsData2()},calcItemsData2:function(){var t;this.C3dConfig={};var e=this.$dest.width(),i=this.$dest.height(),n=this.info.panoModelInfoList[0].width,s=this.info.panoModelInfoList[0].height;var r=this.setting.axiaProfile,o=function(t,e,i,n,a){var s=n/e,r=e/t/(n/i);r>1&&(s*=r);var o=t/2-(i*=s=1/s)/2,h=e/2-(n*=s)/2;return{renderW:i/s,renderH:n/s,scale:s,destW:t,destH:e,positionX:(t/2+(o=o*{left:-1,right:1}[a]||0))/s,positionY:(e/2+(h=h*{top:-1,bottom:1}[a]||0))/s,position:a}}(e,i,n,s,r);this.C3dConfig.scale=o.scale,this.C3dConfig.destW=o.destW,this.C3dConfig.destH=o.destH,this.C3dConfig.renderW=o.renderW,this.C3dConfig.renderH=o.renderH,-1!=(0,h.default)(t=["top","bottom"]).call(t,r)?this.C3dConfig.radius=o.renderH/2:this.C3dConfig.radius=o.renderW/2,(0,a.default)(this.C3dConfig,{right:{axiaX:o.destW/2,axiaRotateZ:0,vectorDrag:[-1,0],vectorOrient:[0,0,-1]},top:{axiaX:o.destH/2,axiaRotateZ:-90,vectorDrag:[0,1],vectorOrient:[0,-1,0]},left:{axiaX:o.destW/2,axiaRotateZ:-180,vectorDrag:[1,0],vectorOrient:[0,0,1]},bottom:{axiaX:o.destH/2,axiaRotateZ:-270,vectorDrag:[0,-1],vectorOrient:[0,1,0]}}[r]),this.C3dConfig.modelRotateZ=-this.C3dConfig.axiaRotateZ,this.C3dConfig.perspectiveOrigin=r,this.C3dConfig.position=r}}),(0,a.default)(P.prototype,{mappingStamps:function(t,e){var i,n=0;this.info.progressStampList=(0,o.default)(i=this.info.panoModelInfoList).call(i,(function(t){return n+=t.deltaSpacing})),this.info.viewStampList=this.info.progressStampList,this.info.progressLength=n;for(var a=this.info.viewStampList,s=[],r=1;r<a.length;r++)s.push((a[r]+a[r-1])/2);s.push(n+1),this.info.progressRightScopeStampList=s,this.calcItemsData3()},calcItemsData3:function(){}}),(0,a.default)(P.prototype,{initStage:function(){var t=this.$dest,e=(new window.C3D.Stage).size(t.width(),t.height()).update();$(e.el).css({"z-index":1}),t.append(e.el),this.C3dObject.iStage=e},modeling:function(){for(var t,e=this.info.progressStampList,i=(this.info.viewStampList,this.info.panoModelInfoList),n=(this.C3dConfig.scale,this.C3dConfig.radius),a=(this.C3dConfig.modelRotateZ,new window.C3D.Sprite),s=0;s<i.length;s++){var o,h=i[s].$el;(0,u.default)(o=h.children("*")).call(o,(function(t,e){return!$(e).hasClass(".hide")})).each((function(t,e){e.style.transform=e.style.transform+"translateZ("+.1*S*t+"px)",e.style.transformStyle="preserve-3d"}));var l=f(n,e[s]),d=new window.C3D.Plane({el:h[0]}).size(h.width(),h.height()).position(-l[1],0,-l[0]).rotate(0,-e[s],this.C3dConfig.modelRotateZ).update();a.addChild(d)}window.addEventListener("keydown",(function(t){t.keyCode=="Q".charCodeAt()&&(a.z-=10,a.update()),t.keyCode=="E".charCodeAt()&&(a.z+=10,a.update()),t.keyCode=="W".charCodeAt()&&(a.y-=10,a.update()),t.keyCode=="S".charCodeAt()&&(a.y+=10,a.update()),t.keyCode=="A".charCodeAt()&&(a.x-=10,a.update()),t.keyCode=="D".charCodeAt()&&(a.x+=10,a.update())}));var c=1/180*Math.PI;function f(t,e){var i=e*(1/180*Math.PI);return[Math.sin(i)*t,Math.cos(i)*t]}var p=this.C3dObject.iStage,g=p.camera.fov=35;p.update(),p.el.style.perspectiveOrigin=this.C3dConfig.position;var m=1/Math.tan(g/2*c)/2;a.position(this.C3dConfig.axiaX,0,-this.C3dConfig.renderH*m).scale(1,1,1*S),a.update(),p.addChild(a),this.C3dObject.iSprite=a,p.camera.rotate(0,0,-this.C3dConfig.axiaRotateZ),p.update(),this.info.$layers=(0,r.default)(t=this.$dest).call(t,".layer-item")},showRangedOnly:function(){R.call(this,this.info.$layers,function(t){for(var e=t.list,i=t.list.length,n=t.start,a=t.end,s=null,r=null,o=0;o<i;o++)if(e[o]>n){s=o;break}for(o=s;o<i;o++)if(e[o]>a){r=o;break}return[s,r=null==r?i:r]}({list:this.info.progressStampList,start:this.status.currentProgress-89,end:this.status.currentProgress+89,count:this.config.renderCount}))}}),(0,a.default)(P.prototype,{createPanoTouchEvent:function(){var t=new window.AlloyFinger(this.$el[0],{touchStart:function(t){cancelAnimationFrame(this.flag.panoRafId),this.flag.panoRafId=requestAnimationFrame(this.panoRafFn),this.status.flagProgress=this.status.currentProgress,this.updateStatus("drag"),this.status.rawSpeed=null,this.orientSensor.turnOff()}.bind(this),touchEnd:function(t){this.status.flagProgress=this.status.currentProgress,this.timeSensor.refresh(),this.orientSensor.turnOn(),this.updateStatus("slip")}.bind(this)});this.PanoTouchEvent=t},initOrientEvent:function(){this.sensorStart(),this.orientRafId=requestAnimationFrame(this.orientRafFn)},orientRafFn:function(){var t=t||this;t._pano.sensorSpeed=this.sensor.deltaPoint[1]/-1,"stop"==this._pano.status&&this.startMoving(),t.sensorRafId=requestAnimationFrame(t.sensorRafFn)},sensorStart:function(){this.orientSensor=new y,this.orientSensor.turn("on")},updateStatus:function(t){this.status.lastStatus=this.status.status,this.status.status=t},stopMoving:function(){cancelAnimationFrame(this.flag.panoRafId),this.updateStatus("stop"),this.updatePanoRender()},panoRafFn:function(){this.flag.panoRafId=requestAnimationFrame(this.panoRafFn),this.updatePanoData()},updatePanoData:function(){var t;this.status.lastProgress=this.status.currentProgress;var e,i,n=this.status.status,a=b(this.C3dConfig.vectorDrag,[this.touchSensor.deltaX,this.touchSensor.deltaY])*S,s=b(this.C3dConfig.vectorDrag,[this.touchSensor.speedX,this.touchSensor.speedY])*S,r=this.setting.orientable?b(this.C3dConfig.vectorOrient,this.orientSensor.deltaPoint):0,o=this.timeSensor.delta;"drag"==n?(t=this.status.flagProgress+a*this.config.directionY*this.config.kProgress,this.status.currentProgress=t):"slip"==n&&(t=this.status.currentProgress,t+=this.status.rawSpeed?this.status.rawSpeed/1e3*o:s*o*this.config.directionY*this.config.kProgress,t+=r*S*3/1e3*o||0),e=t,i=[0,this.info.progressLength],t=Math.min(Math.max(e,i[0]),i[1]),this.status.currentProgress=t,this.status,this.dispatchCurrentEvent(this.status.lastProgress,this.status.currentProgress),this.dispatchSelfEvent(this.status.lastProgress,this.status.currentProgress),"drag"!=this.status.status&&this.status.lastProgress,this.updatePanoRender()},updatePanoRender:function(){this.C3dObject.iSprite.rotationY=this.status.currentProgress*S,this.C3dObject.iSprite.updateT(),this.showRangedOnly()}}),(0,a.default)(P.prototype,{dispatchCurrentEvent:function(t,e){this.status.viewIndex;var i,n,a,s,r=this.status.goneIndex;a=(0,l.default)(i=this.info.progressRightScopeStampList).call(i,(function(t){return e<t})),s=(0,l.default)(n=this.info.progressStampList).call(n,(function(t){return e<t+90+.5}))-1,this.status.viewIndex=a,this.status.goneIndex=s,this.status.lastViewIndex==a&&T(this.status.currentProgress,this.info.progressStampList[a],10)||(this.status.itemEvented=!1,this.status.lastViewIndex=a),T(this.status.currentProgress,this.info.progressStampList[a],t-e)&&this.triggerIntoItem(),r<s&&this.triggerGoneItem()},dispatchSelfEvent:function(t,e){0==t&&e>0&&this.triggerStartPlay(),t<this.info.progressLength&&e==this.info.progressLength&&this.triggerEndPlay(),e<this.info.progressLength-10&&(this.status.endEvented=!1)},triggerStartPlay:function(){this.status.startEvented||(this.status.startEvented=!0,interaction_view.events.onLongTakeStart(this.viewObject,{}))},triggerEndPlay:function(){this.status.endEvented||(this.status.endEvented=!0,interaction_view.events.onLongTakeEnd(this.viewObject,{}))},triggerIntoItem:function(){if(!this.status.itemEvented){this.status.itemEvented=!0;var t=this.info.layerIdList[this.status.viewIndex];if(null!=t){var e={ref_id:this.viewObject.model.id,layer_id:t,page_id:this.viewObject.model.iPageId};interaction_view.events.onLTLayerInto(e)}}},triggerGoneItem:function(){this.triggerGoneItem=_.debounce((function(){var t=this.info.layerIdList[this.status.goneIndex];if(null!=t){var e={ref_id:this.viewObject.model.id,layer_id:t,page_id:this.viewObject.model.iPageId};interaction_view.events.onLTLayerGone(e)}}),20,!0),this.triggerGoneItem()}}),(0,a.default)(w.prototype,{initialize:function(){this.uid="touchSensor-"+I(),this.status="stop",this.lastStatus="stop",this.x=0,this.y=0,this.deltaX=0,this.deltaY=0,this.speedX=0,this.speedY=0,this.touchEvent=this._bindTouchEvent()},reset:function(){this.x=0,this.y=0},destroy:function(){this.touchEvent.destroy()},_bindTouchEvent:function(){var t=this,e=null,i=null;function n(e){t.lastStatus=t.status,t.status=e}return new window.AlloyFinger(window,{touchStart:function(i){e=i.timeStamp,t.deltaX=0,t.deltaY=0,n("drag")},touchEnd:function(a){0==a.touches.length&&(n("slip"),i=a.timeStamp-e,e=a.timeStamp,i>90&&(t.speedX=0,t.speedY=0))},pressMove:function(n){n.preventDefault(),t.x+=n.deltaX,t.y+=n.deltaY,t.deltaX+=n.deltaX,t.deltaY+=n.deltaY,i=n.timeStamp-e,e=n.timeStamp,i>6&&(i>90&&(i=16),t.speedX=n.deltaX/i,t.speedY=n.deltaY/i)},_checkSpeed:function(){}})}}),(0,a.default)(y.prototype,{initData:function(){return this.point=[0,0,0],this.deltaPoint=[0,0,0],this.startPoint=[0,0,0],this.status="off",this._raw={alpha:0,beta:0,gamma:0,alpha0:void 0,beta0:void 0,gamma0:void 0},this},recordPoint:function(t){var e=this._raw;return t&&t.originalEvent&&(t=t.originalEvent,e.alpha=t.alpha,e.beta=t.beta,e.gamma=t.gamma,this.point[0]=e.alpha,this.point[1]=e.beta,this.point[2]=e.gamma),this.setDelta(),this},setDelta:function(){var t=this._raw;void 0!==t.alpha0&&(this.deltaPoint[0]=t.alpha-t.alpha0,this.deltaPoint[1]=t.beta-t.beta0,this.deltaPoint[2]=t.gamma-t.gamma0)},markStart:function(t){var e=this._raw;return e.toMark&&(e.toMark=!1,t&&t.originalEvent?(t=t.originalEvent,e.alpha0=t.alpha,e.beta0=t.beta,e.gamma0=t.gamma):(e.alpha0=e.alpha,e.beta0=e.beta,e.gamma0=e.gamma),this.startPoint[0]=e.alpha0,this.startPoint[1]=e.beta0,this.startPoint[2]=e.gamma0,this.setDelta()),this},turn:function(t){return"on"==t&&this.turnOn(),"off"==t&&this.turnOff(),this},turnOn:function(){var t=this._raw;return"on"!=this.status&&(this.status="on",t.recordPoint=this.recordPoint.bind(this),t.markStart=this.markStart.bind(this),$(window).on("deviceorientation",t.recordPoint),t.toMark=!0,$(window).on("deviceorientation",t.markStart)),this},turnOff:function(){return $(window).off("deviceorientation",this._raw.recordPoint),this.status="off",this.initData(),this}});var C=Date.now;function b(t,e){var i=(0,l.default)(t).call(t,(function(t){return 0!=t}));return e[i]*(0,c.default)(t[i])}function I(t){t=t||6;for(var e,i="";t;){var n;e=t>8?8:t,i+=(0,s.default)(n=Math.random().toString(36)).call(n,-e),t-=e}return i}function R(t,e){for(var i=t.length,n=e[0],a=e[1],s=0;s<i;s++)t[s].style.display=n<=s&&s<a?"block":"none"}function T(t,e,i){return i=null!=i?Math.abs(i):1e-6,t==e||Math.abs(t-e)<i}!function(){for(var t=[],e=-1,i=!1,n=null,a=Date.now,s=0,r=["ms","moz","webkit","o"],o=0;o<r.length&&!window.requestAnimationFrame;++o)window.requestAnimationFrame=window[r[o]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[o]+"CancelAnimationFrame"]||window[r[o]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,e){var i=a(),n=Math.max(0,16-(i-s)),r=window.setTimeout((function(){t(i+n)}),n);return s=i+n,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var h=function(s,r){if(e++,t.push({id:e,fn:s,interval:r,lastTime:a()}),!i){i=!0,function e(){n=requestAnimationFrame(e),function(t,e){if(Array.prototype.forEach)t.forEach(e);else for(var i=0,n=t.length;i<n;i++)e(t[i],i)}(t,(function(t){(t.interval<17||a()-t.lastTime>=t.interval)&&(t.fn(),t.lastTime=a())}))}()}return e},u=function(e){for(var a=0,s=t.length;a<s;a++)if(e===t[a].id){(0,d.default)(t).call(t,a,1);break}0===t.length&&(cancelAnimationFrame(n),i=!1)};window.setRafInterval=h,window.clearRafInterval=u,window.setRafTimeout=function(t,e){var i=a()+e,n=h((function(){a()>=i&&(t(),u(n))}),16);return n},window.clearRafTimeout=function(t){u(t)},Date.now||(Date.now=function(){return(new Date).getTime()})}(),Date.now,m.prototype={start:function(){return this._startT||(this._startT=this._rawStartT=this._lastT=C(),this._deltaT=this._deltaP0=this._deltaP1=0,this._pausedT=null),this},stop:function(){return this._lastT=this._currentT=this._deltaT=this._pausedT=this._delta0=this._startT=this._rawStartT=null,this},refresh:function(){return this._pausedT?this._deltaT=C()-this._lastT-this._deltaP1-this._deltaP2():(this._deltaT=C()-this._lastT-this._deltaP1,this._deltaP0+=this._deltaP1,this._deltaP1=0,this._lastT=C()),this},get delta(){return this.refresh()._deltaT},get value(){return C()-this._startT-this._deltaP0-this._deltaP1-this._deltaP2()},_deltaP2:function(t){return this._pausedT?(t||C())-this._pausedT:0},pause:function(t){return this._pausedT||(this._pausedT=C()),this},resume:function(t){this._resume(t)},_resume:function(t,e){return this._pausedT&&(this._deltaP1+=this._deltaP2(),this._pausedT=null),this},forward:function(t){},backward:function(t){},seek:function(t){},valueOf:function(){return this.value},toString:function(){return this.value}},window.lclog=function(){},epub360.PlayerPlugins.push({config:{type:"LayerRound",template:"LayerRef",Model:"LayerRef",model_object:{setiview:function(){this.iview=new interaction_view.view.LayerRound({model:this})}}},render:function(t){},playAnimation:function(){},resetOtherStatus:function(){},getLayerContentSize:function(){var t=this.getdetail(),e={};if(!t.layer_ids||t.layer_ids.length>0){var i=(0,o.default)(_).call(_,t.layer_ids,(function(t){return interaction_view.ilayerlist.get(t).toJSON()}));return e.width=_.max(_.pluck(i,"layer_width")),e.height=_.max(_.pluck(i,"layer_height")),e}return null},onPlay:function(){this.startPano()},onStop:function(){var t=t||this;t._pano;t.resetlayer(),t.stoplayer(),this.stopPano()},startPano:function(){this.pano=new P(this),this.pano.prefixTouch(),this.pano.autoPlay()},stopPano:function(){var t,e;this.pano.stopMoving(),this.pano.status.currentProgress=0,this.pano.updatePanoRender(),this.pano.touchSensor.destroy();var i=(0,r.default)(t=this.$el).call(t,".layer-item").detach();this.pano.C3dObject.iStage.el.remove(),(0,r.default)(e=this.$el).call(e,".layer-content").append(i)},panolog:function(){},playNestedAnimation:function(){_.each(this.model.layer,(function(t){t.isLayer=!0,interaction_view.play(t)}))}})}.apply(e,n))||(t.exports=a)},2653:function(t,e,i){t.exports=i(2654)},2654:function(t,e,i){var n=i(2655);t.exports=n},2655:function(t,e,i){i(2656);var n=i(6);t.exports=n.Math.sign},2656:function(t,e,i){i(2)({target:"Math",stat:!0},{sign:i(2657)})},2657:function(t,e){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}}}]);