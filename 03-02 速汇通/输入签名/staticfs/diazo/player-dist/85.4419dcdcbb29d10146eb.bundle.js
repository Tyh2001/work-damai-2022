(window.webpackJsonp=window.webpackJsonp||[]).push([[85],{2674:function(e,t,a){var i,n;i=[a(100),a(125),a(213),a(8),a(10),a(342),a(215),a(4),a(14),a(78),a(27),a(63)],void 0===(n=function(e,t,i,n,o,r,s,l,h,d,u,c){"use strict";var f=a(0);r=f(r),s=f(s),l=f(l),h=f(h),d=f(d),u=f(u),c=f(c),function(){function e(e){var t=(0,r.default)(e).call(e,(function(e,t){return e-t})),a={};t.push(1/0),t.forEach((function(e){a[e]=e}));for(var i=t[0],n=0,o=0;o<t.length;o++)i+2<t[o]&&(o-1>n&&(0,s.default)(a,h((0,l.default)(t).call(t,n,o))),n=o,i=t[o]);function h(e){for(var t={},a=0;a<e.length;a++){var i=e[a];t[i]=void 0===t[i]?1:t[i]+1}var n=[];for(var a in t)n.push({e:a,count:t[a]});(0,r.default)(n).call(n,(function(e,t){return t.count-e.count}));var o=+n[0].e;for(var a in t)t[a]=o;return t}return t.pop(),delete a[1/0],a}epub360.PlayerPlugins.push({config:{type:"LayerPano",template:"LayerRef",Model:"LayerRef",model_object:{setiview:function(){this.iview=new interaction_view.view.LayerPano({model:this})}}},loadLayer:function(e){var t=this.getdetail();this.layerCheckList=_.clone(t.layer_ids),this.firstlayer=t.layer_ids?t.layer_ids[0]:null,this.preloadmodel=e;var a=this._getLayerView();for(var i in a=_g.mvc.createView(a),t.layer_ids){var n=interaction_view.ilayerlist.get(t.layer_ids[i]);n&&!n.attributes.pano_eid&&(n.attributes.pano_eid=this.model.pageid+this.model.id+t.layer_ids[i])}return this.layerview=new a({model:this.model}),this.layerview.afterload(),this},render:function(e){},playAnimation:function(){},resetOtherStatus:function(){},getLayerContentSize:function(){var e=this.getdetail(),t={};if(!e.layer_ids||e.layer_ids.length>0){var a=(0,h.default)(_).call(_,e.layer_ids,(function(e){return interaction_view.ilayerlist.get(e).toJSON()}));return t.width=_.max(_.pluck(a,"layer_width")),t.height=_.max(_.pluck(a,"layer_height")),t}return null},onPlay:function(){var e;this.playNestedAnimation(),this.prefixTouch();var t=t||this;t.initRuntimePano();var a=t.__pano,i=(0,d.default)(e=this.$el.children(".Element")).call(e,".layer-content");i.length&&(a.$dest=i,a.iStage||(t.calcModelData(),t.initStage(i)),t.modeling(a.items,i),t.updatePanoInfo(),t.panoRafId=requestAnimationFrame(t.panoRafFn),t.initEvents())},onStop:function(){this.resetlayer(),this.stoplayer(),this.stopPano()},playNestedAnimation:function(){var e=e||this;e.__pano;_.each(e.getdetail().layer_ids,(function(t){e.model.layer[t].isLayer=!0,interaction_view.play(e.model.layer[t])}))},prefixTouch:function(){var e=this.$el.children(".Element");(0,d.default)(e).call(e,".layer-item").children().css({"pointer-events":"initial"}),(0,d.default)(e).call(e,".layer-item, .layer-bg").css({"pointer-events":"none"}),e.addClass("disableDragX disableDragY")},stopPano:function(){cancelAnimationFrame(this.panoRafId),this.sensorStop(),this.__pano.draggable&&this.fingerEvent&&this.fingerEvent.destroy()},toRadian:1/180*Math.PI,updatePanoInfo:function(){var e=e||this,t=e.__pano,a=t.rawInfo;a.hMaxDegree=this.degreeRange(t.hModelDegree,a.fov)},degreeRange:function(e,t){return Math.max(e-t/2*.9,0)},initRuntimePano:function(){var e=e||this;e.__pano=e.__pano||{},e.resetStage(),e.initPanoRawInfo(),e.__pano.flag=Date.now()},initPanoRawInfo:function(){var e=e||this,t=e.__pano;this.__pano.rawInfo={depth:0,x:0,y:0,scale:1,speedX:0,speedY:0},this.__pano.rawInfo.fov=t.iStage?t.iStage.camera.fov:75;var a=1/180*Math.PI/2;this.__pano.rawInfo.scale=Math.tan(75*a)/Math.tan(this.__pano.rawInfo.fov*a),this.__pano.rawInfo.status},initStage:function(e){var t=t||this,a=t.__pano,i=(new window.C3D.Stage).size(e.width(),e.height()).update();e.append(i.el),a.iStage=i,a.iSprites=[]},resetStage:function(){var e,t,a,i,n=n||this,o=n.__pano;o.iSprites=[],o.touchRecord=new Array(3),o.isTouching=!1,o.touchPoint=0,o.speedIndicator=[0,0],o.speedIntegral=(0,u.default)(e=new Array(6)).call(e,0),o.rawVertical=0,o.rawHorizontal=(0,u.default)(t=new Array(6)).call(t,0),o.historyX=(0,u.default)(a=new Array(6)).call(a,0),o.historyDepth=(0,u.default)(i=new Array(6)).call(i,0),o.rawDepth=-50,o.initDepth=-50,o.largestRadius=void 0;var r=n.getdetail();o.draggable=void 0===r.iPanoDraggable||Boolean(r.iPanoDraggable),o.useSensor=void 0!==r.iPanoUseSensor&&Boolean(r.iPanoUseSensor),o.pinchable=void 0!==r.iPanoPinchable&&Boolean(r.iPanoPinchable)},calcModelData:function(){var e=e||this,t=e.__pano,a=[];a=e.generateBg(a),a=e.generateItem(a),t.items=a},heightFix:function(e,t,a){return e&&t&&null!=a?e*(t-a)/((e-a)*t):1},bgClipper:function(e,t){for(var a=[],i=t/20,n=0;n<20;n++)a.push(e+"?imageMogr2/crop/!"+i+"xa"+i*n);return a},generateBg:function(e){var t,a=a||this,i=a.__pano;return(0,r.default)(t=a.getdetail().background).call(t,(function(e,t){return t.radius-e.radius})).forEach((function(t,n){if(t.using){var o=t.url,r=2*Math.PI/20,l=.5*t.radius,h=Math.ceil(2*Math.tan(r/2)*l),d=Math.ceil(20*h/2),u=Math.atan(d/2/(l-i.initDepth))/a.toRadian;i.hModelDegree=u,i.largestRadius||(i.largestRadius=l);var c={width:h+"px",height:d*a.heightFix(i.largestRadius,l,i.rawDepth)+"px","backface-visibility":"hidden","background-repeat":"no-repeat","background-position":"center"},f=o.match(/^\.\/staticfs/);f?(0,s.default)(c,{"background-image":'url("'+o+'")',"background-size":"2000% 100%"}):(0,s.default)(c,{"background-size":"100% 100%"});for(var p=a.bgClipper(o,t.size[0]),g=[],v=0;v<20;v++){var w=v-10+.5,y=w*r,m=$("<div></div>").css(c);f?m.css({"background-position-x":-v*h+"px"}):m.css({"background-image":'url("'+p[v]+'")'}),g.push({$el:m,width:h,height:d,position:[l*Math.sin(y),0,-l*Math.cos(y)],rotation:18*-w})}e.push(g)}})),e},generateItem:function(t){var a=a||this,i=a.__pano;for(var n in a.model.layer){var o=interaction_view.ilayerlist.get(n);if(o){var r,s=-o.attributes.layer_height/2,l=2*Math.PI/o.attributes.layer_width,d=-180/Math.PI,u=200*l,c=a.model.layer[n],f=[],p=e((0,h.default)(r=c.iOverlaylist.models).call(r,(function(e){return e.iview.x}))),g={};c.iOverlaylist.models.forEach((function(e){var t=p[e.iview.x];g[t]=void 0===g[t]?0:g[t]+1;var n=200-g[t]/10,o=(e.attributes.iCommon.landscape,[t,e.iview.y]),r=l*o[0]-Math.PI,h=e.iview.$el,c=a.heightFix(i.largestRadius,n,i.rawDepth);f.push({$el:h,position:[n*Math.sin(r),(o[1]+s)*u*c,-n*Math.cos(r)],rotation:r*d,scale:u})})),t.push(f)}}return t},modeling:function(e,t){var a=a||this,i=a.__pano;e.forEach((function(e){for(var t=new C3D.Sprite,a=0;a<e.length;a++){var n=e[a],o=new C3D.Plane({el:n.$el[0]}).position(n.position[0],n.position[1],n.position[2]).rotation(0,n.rotation,0).scale(n.scale||1);n.width&&n.height&&o.size(n.width,n.height),o.update(),t.addChild(o)}t.position(0,0,0),t.z=i.rawDepth,t.updateT(),i.iStage.addChild(t),i.iSprites.push(t)}))},panoRafFn:function(){var e,t,a,i,n=n||this,o=n.__pano,r=o.rawInfo;("slip"==r.status&&(r.x+=r.speedX,r.y+=r.speedY,r.speedX=n.springBack(r.speedX,0,.9),r.speedY=n.springBack(r.speedY,0,.9),s(r.speedX,0,.1)&&s(r.speedY,0,.1)&&(r.speedX=0,r.speedY=0,t="stop",o.rawInfo.status=t)),"pinch"==r.status&&(o.iStage.camera.fov=r.fov,o.iStage.updateT()),r.finalX=r.x,r.finalY=r.y,o.useSensor&&-1==(0,c.default)(e=["drag","pinch"]).call(e,r.status)&&(r.finalX=r.x+(n.sensor.deltaPoint[0]||0)+(n.sensor.deltaPoint[2]||0),r.finalY=r.y+n.sensor.deltaPoint[1]/2),r.finalY=n.rangeOut(r.finalY,-r.hMaxDegree,r.hMaxDegree),o.historyX[0])?(o.historyX.push(r.finalX),o.historyX.shift()):(0,u.default)(a=o.historyX).call(a,r.finalX);(r.depth=n.springBack(r.depth,0,.9),o.historyDepth[0])?(o.historyDepth.push(r.depth),o.historyDepth.shift()):(0,u.default)(i=o.historyDepth).call(i,r.depth);function s(e,t,a){return a=null!=a?Math.abs(a):1e-6,e==t||Math.abs(e-t)<a}r.finalDepth=n.slowMo(o.historyDepth,3,6),o.iSprites.forEach((function(e,t){n.updateSpriteModel(e,t),e.updateT()})),n.panoRafId=requestAnimationFrame(n.panoRafFn)},updateSpriteModel:function(e,t){var a=a||this,i=a.__pano,n=i.rawInfo;switch(e.rotationX=i.rawInfo.finalY,e.rotationY=i.rawInfo.finalX,t){case 0:e.rotationY=i.historyX[2];break;case 1:e.rotationY=i.historyX[5];break;case 2:e.rotationY=i.historyX[3]}e.rotationY=-e.rotationY,e.z=i.rawDepth-n.finalDepth},slowMo:function(e,t,a){for(var i=0,n=t;n<a;n++)i+=e[n];return i/(a-t)},preventRange:function(e,t){return e<t[0]?e=t[0]:e>t[1]&&(e=t[1]),e},springBack:function(e,t,a){var i=(1-a)*(t-=0)+a*(e-=0);return i==Number(i)?i:e},rangeOut:function(e,t,a,i,n){var o;return o=e+~~n,i?(i=1-i,e<t?(o+=Math.min(t-e,n)*i,o-=Math.max(o-a,0)*i):e>a?(o-=Math.max(a-e,n)*i,o-=Math.max(t-o,0)*i):o=o-Math.max(o-a,0)*i-Math.max(t-o,0)*i):o<t?o=t:a<o&&(o=a),o},keyMoving:function(e){var t=t||this,a=t.__pano;window.moveKey.a&&(e.x+=10),window.moveKey.d&&(e.x-=10),window.moveKey.w&&(a.rawDepth+=10),window.moveKey.s&&(a.rawDepth-=10),window.moveKey.space&&(e.y+=10),window.moveKey.shift&&(e.y-=10)},initEvents:function(){var e=e||this,t=e.__pano;this.initAlloyFinger(),this.initKeyEvent(),t.useSensor&&this.initSensorEvent()},initKeyEvent:function(){window.moveKey={};var e=e||this;window.addEventListener("keydown",(function(t){var a=e.__pano;t.keyCode=="Q".charCodeAt()&&(a.iStage.camera.fov+=1,a.iStage.update()),t.keyCode=="E".charCodeAt()&&(a.iStage.camera.fov-=1,a.iStage.update()),t.keyCode=="R".charCodeAt()&&a.iSprites.forEach((function(e,t){e.x=0,e.y=0,a.rawDepth=0,e.updateT()}))})),window.addEventListener("keydown",(function(e){switch(e.keyCode){case 65:window.moveKey.a=!0;break;case 68:window.moveKey.d=!0;break;case 87:window.moveKey.w=!0;break;case 83:window.moveKey.s=!0;break;case 32:window.moveKey.space=!0;break;case 16:window.moveKey.shift=!0}}),!0),window.addEventListener("keyup",(function(e){switch(e.keyCode){case 65:window.moveKey.a=!1;break;case 68:window.moveKey.d=!1;break;case 87:window.moveKey.w=!1;break;case 83:window.moveKey.s=!1;break;case 32:window.moveKey.space=!1;break;case 16:window.moveKey.shift=!1}}),!0)},initAlloyFinger:function(){var e,t,a=a||this,i=a.__pano,n=i.rawInfo,o=i.$dest[0],r=(o.offsetLeft,o.offsetWidth,o.offsetTop,o.offsetHeight,e=null);var s=1/180*Math.PI/2;var l=function(e){n.status=e};a.fingerEvent=new window.AlloyFinger(o,{touchStart:function(t){e=t.timeStamp,i.draggable&&(n.x=n.finalX||0,n.y=n.finalY||0,n.speedX=0,n.speedY=0,l("drag"))},touchEnd:function(e){var t,o=e.touches.length;1==o?(i.draggable&&(l("drag"),n.speedX=0,n.speedY=0),!i.draggable&&i.pinchable&&((0,u.default)(t=i.historyX).call(t,n.finalX),a.sensorStart())):0==o&&l("slip")},pressMove:function(t){if(i.draggable){t.preventDefault(),n.x+=.16*t.deltaX/n.scale,n.y+=.12*t.deltaY/n.scale,n.depth+=Math.abs(.2*t.deltaX/n.scale),n.y=a.rangeOut(n.y,-n.hMaxDegree,n.hMaxDegree);var o=t.timeStamp-e;o>6&&(n.speedX=t.deltaX/o*1e3/60*.16/n.scale,n.speedY=t.deltaY/o*1e3/60*.12/n.scale),e=t.timeStamp}},multipointStart:function(e){r=n.scale,n.x,n.y,t=n.fov},pinch:function(e){var o,h,d;!i.draggable&&i.pinchable&&(n.x=n.finalX,n.y=n.finalY,(0,u.default)(o=i.historyX).call(o,n.finalX),a.sensorStop());i.pinchable&&(l("pinch"),n.scale=a.rangeOut(r*e.zoom,1,4),i.draggable||(n.finalX=n.x,n.finalY=n.y),n.fov=(h=t,d=n.scale/r,Math.atan(Math.tan(h*s)/d)/s),n.hMaxDegree=a.degreeRange(i.hModelDegree,n.fov))}})},initSensorEvent:function(){var e=function(){var e;this.id="sensor-"+(0,l.default)(e=Math.random().toString(36)).call(e,-6),this.initData()};_.extend(e.prototype,{initData:function(){return this.point=[0,0,0],this.deltaPoint=[0,0,0],this.startPoint=[0,0,0],this.status="off",this.__raw={alpha:0,beta:0,gamma:0,alpha0:void 0,beta0:void 0,gamma0:void 0},this},recordPoint:function(e){var t=this.__raw;return t.alpha=e.alpha||0,t.beta=e.beta||0,t.gamma=e.gamma||0,this.point[0]=t.alpha,this.point[1]=t.beta,this.point[2]=t.gamma,null==t.alpha0&&(t.alpha0=t.alpha,t.beta0=t.beta,t.gamma0=t.gamma,this.startPoint[0]=t.alpha0,this.startPoint[1]=t.beta0,this.startPoint[2]=t.gamma0),this.deltaPoint[0]=t.alpha-t.alpha0,this.deltaPoint[1]=t.beta-t.beta0,this.deltaPoint[2]=t.gamma-t.gamma0,this},turn:function(e){return"on"==e&&this.turnOn(),"off"==e&&this.turnOff(),this},turnOn:function(){return"on"!=this.status&&(this.status="on",this.__raw.recordPoint=this.recordPoint.bind(this),window.addEventListener("deviceorientation",this.__raw.recordPoint)),this},turnOff:function(){return window.removeEventListener("deviceorientation",this.__raw.recordPoint),this.status="off",this.initData(),this}});var t=t||this,a=t.__pano,i=(a.rawInfo,new e);i.turn("on"),a.draggable&&(a.$dest[0].addEventListener("touchstart",(function(e){i.turnOff()})),a.$dest[0].addEventListener("touchend",(function(e){0==e.touches.length&&i.turnOn()}))),this.sensor=i},sensorStart:function(){var e=e||this;e.__pano.useSensor&&e.sensor.turn("on")},sensorStop:function(){var e=e||this;e.__pano.useSensor&&e.sensor.turn("off")}})}()}.apply(t,i))||(e.exports=n)}}]);